# 路由白名单配置说明

## 概述

本项目已实现路由白名单功能，确保除了白名单中的路由外，其他所有路由都需要验证 token，否则自动跳转到登录页。

## 配置位置

白名单配置在 `src/config/index.js` 文件中：

```javascript
// 路由白名单（不需要登录）
whiteList: ['/login', '/register', '/404', '/403']
```

## 工作原理

### 1. 路由守卫逻辑（`src/router/guards.js`）

路由守卫按以下顺序进行检查：

1. **白名单检查**
   - 如果访问的路由在 `config.whiteList` 中，直接放行
   - 白名单路由无需任何验证

2. **Token 验证**
   - 如果不在白名单中，必须验证是否有 token
   - 没有 token 则重定向到登录页，并携带 redirect 参数用于登录后跳转回原页面

3. **登录页重定向**
   - 如果已登录用户访问登录页，自动重定向到首页

4. **用户信息获取**
   - 首次访问时获取用户信息
   - 生成并添加动态路由
   - 如果获取失败，清除 token 并跳转登录页

5. **角色权限检查**
   - 对于需要特定角色的路由，检查用户是否拥有所需角色
   - 无权限则跳转到 403 页面

### 2. 核心代码

```javascript
// 1. 检查是否在白名单中（使用 config 中的配置）
if (config.whiteList.includes(to.path)) {
  // 白名单路由直接放行
  next()
  return
}

// 2. 不在白名单中的路由，必须验证 token
if (!token) {
  // 未登录，重定向到登录页
  const redirect = to.fullPath !== '/' ? to.fullPath : ''
  next(`/login${redirect ? `?redirect=${encodeURIComponent(redirect)}` : ''}`)
  return
}
```

## 如何添加白名单路由

在 `src/config/index.js` 中的 `whiteList` 数组中添加路由路径：

```javascript
whiteList: [
  '/login',      // 登录页
  '/register',   // 注册页
  '/404',        // 404 页面
  '/403',        // 403 页面
  '/about',      // 新增：关于页面
  '/help'        // 新增：帮助页面
]
```

## 路由配置说明

在 `src/router/routes.js` 中，路由的 `meta.requiresAuth` 字段已不再影响白名单逻辑：

- **白名单优先**：只要路由在 `config.whiteList` 中，就不需要验证
- **非白名单路由**：一律需要 token 验证
- **角色权限**：通过 `meta.roles` 字段控制

### 示例

```javascript
{
  path: '/home',
  name: 'Home',
  component: () => import('@/views/home/index.vue'),
  meta: {
    title: '首页',
    requiresAuth: true,  // 此字段不影响白名单判断
    keepAlive: true
  }
}
```

## 安全性说明

### 优势

1. **统一管理**：所有白名单路由在一个配置文件中管理
2. **默认安全**：除白名单外，所有路由默认需要验证
3. **防止绕过**：即使路由配置了 `requiresAuth: false`，也必须在白名单中才能免验证

### 注意事项

1. **谨慎添加白名单**：只将真正不需要登录的页面加入白名单
2. **敏感页面保护**：用户信息、订单、支付等页面不应加入白名单
3. **错误页面**：404、403 等错误页面应在白名单中，避免无限重定向

## 测试建议

### 1. 测试白名单路由

- 清除 token
- 访问白名单中的路由（如 `/login`、`/404`）
- 应该能正常访问，不会跳转到登录页

### 2. 测试非白名单路由

- 清除 token
- 访问非白名单路由（如 `/home`、`/user`）
- 应该自动跳转到登录页，并携带 redirect 参数

### 3. 测试登录后跳转

- 清除 token
- 访问 `/home`
- 登录成功后应自动跳转回 `/home`

### 4. 测试角色权限

- 以普通用户身份登录
- 访问需要 admin 角色的路由
- 应该跳转到 403 页面

## 相关文件

- `src/config/index.js` - 白名单配置
- `src/router/guards.js` - 路由守卫实现
- `src/router/routes.js` - 路由定义
- `src/store/modules/user.js` - 用户状态管理
- `src/utils/auth.js` - Token 存储工具
